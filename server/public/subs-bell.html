<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Subscription Bell Settings - PushSaaS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .preview-container {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
    </style>
</head>

<body class="bg-gray-50">
    <div id="app" class="p-6 min-h-screen">
        <!-- Header -->
        <div class="mb-6">
            <div class="flex items-center gap-2 mb-4">
                <h1 class="text-xl font-semibold text-gray-800">Subscription Bell Settings</h1>
                <span id="status-badge" class="px-2 py-1 bg-green-500 text-white text-xs rounded font-medium">
                    Active
                </span>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading" class="text-center py-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-2 text-gray-600">Cargando configuraciones...</p>
        </div>

        <!-- Error State -->
        <div id="error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-red-400" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
                            clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">Error</h3>
                    <div class="mt-2 text-sm text-red-700">
                        <p id="error-message">Ha ocurrido un error al cargar la configuración.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="main-content" class="hidden">
            <div class="flex gap-8">
                <!-- Left Panel - Settings Form -->
                <div class="flex-1 max-w-md">
                    <!-- Styling Options -->
                    <div class="mb-8">
                        <h2 class="text-sm font-medium text-gray-600 mb-4">Opciones de Estilo</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm text-gray-700 mb-1">Estilo:</label>
                                <select id="style"
                                    class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="Rounded">Redondeado</option>
                                    <option value="Square">Cuadrado</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-700 mb-1">Posición:</label>
                                <select id="position"
                                    class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="Bottom Left">Abajo Izquierda</option>
                                    <option value="Bottom Right">Abajo Derecha</option>
                                    <option value="Top Left">Arriba Izquierda</option>
                                    <option value="Top Right">Arriba Derecha</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-700 mb-1">Tema:</label>
                                <select id="theme"
                                    class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="Dark">Oscuro</option>
                                    <option value="Light">Claro</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-700 mb-1">Color del Tema:</label>
                                <input type="color" id="themeColor"
                                    class="w-full h-10 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                    </div>

                    <!-- Action Button Configuration -->
                    <div class="mb-8">
                        <h2 class="text-sm font-medium text-gray-600 mb-4">Configuración de Botones de Acción</h2>

                        <!-- Default State -->
                        <div class="mb-6">
                            <h3 class="text-sm font-medium text-gray-700 mb-2">Estado por Defecto</h3>
                            <div class="space-y-2">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">Título:</label>
                                    <textarea id="defaultTitle" rows="2"
                                        class="w-full p-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">Texto del Botón:</label>
                                    <input type="text" id="defaultButtonText"
                                        class="w-full p-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>

                        <!-- Subscribed State -->
                        <div class="mb-6">
                            <h3 class="text-sm font-medium text-gray-700 mb-2">Cuando está Suscrito</h3>
                            <div class="space-y-2">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">Título:</label>
                                    <textarea id="subscribedTitle" rows="2"
                                        class="w-full p-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">Texto del Botón:</label>
                                    <input type="text" id="subscribedButtonText"
                                        class="w-full p-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>

                        <!-- Unsubscribed State -->
                        <div class="mb-6">
                            <h3 class="text-sm font-medium text-gray-700 mb-2">Cuando está Desuscrito</h3>
                            <div class="space-y-2">
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">Título:</label>
                                    <textarea id="unsubscribedTitle" rows="2"
                                        class="w-full p-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                                </div>
                                <div>
                                    <label class="block text-xs text-gray-600 mb-1">Texto del Botón:</label>
                                    <input type="text" id="unsubscribedButtonText"
                                        class="w-full p-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Show Notifications Toggle -->
                    <div class="mb-8">
                        <div class="flex items-center justify-between">
                            <label class="text-sm text-gray-700">Mostrar últimas 3 notificaciones:</label>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="showLastNotifications" class="sr-only">
                                <div id="toggleBg" class="w-10 h-6 bg-gray-300 rounded-full transition-colors">
                                    <div id="toggleCircle"
                                        class="w-4 h-4 bg-white rounded-full shadow transform transition-transform mt-1 translate-x-1">
                                    </div>
                                </div>
                            </label>
                        </div>
                    </div>

                    <!-- Headings -->
                    <div class="mb-8">
                        <h2 class="text-sm font-medium text-gray-600 mb-4">Encabezados</h2>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Por Defecto:</label>
                                <textarea id="defaultHeading" rows="2"
                                    class="w-full p-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">Cuando está suscrito:</label>
                                <textarea id="subscribedHeading" rows="2"
                                    class="w-full p-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex gap-3">
                        <button id="hideBellBtn"
                            class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors">
                            Ocultar Campana
                        </button>
                        <button id="updateBtn"
                            class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors">
                            Actualizar Configuración
                        </button>
                    </div>
                </div>

                <!-- Right Panel - Preview -->
                <div class="flex-1 max-w-lg">
                    <div class="mb-4">
                        <h2 class="text-sm font-medium text-gray-600">Vista Previa</h2>
                    </div>

                    <!-- Preview Tabs -->
                    <div class="mb-4">
                        <div class="flex gap-1 bg-gray-100 p-1 rounded">
                            <button
                                class="preview-tab px-3 py-1 text-xs rounded transition-colors bg-blue-500 text-white"
                                data-tab="Default">Por Defecto</button>
                            <button
                                class="preview-tab px-3 py-1 text-xs rounded transition-colors text-gray-600 hover:bg-white"
                                data-tab="When Subscribed">Suscrito</button>
                            <button
                                class="preview-tab px-3 py-1 text-xs rounded transition-colors text-gray-600 hover:bg-white"
                                data-tab="When Unsubscribed">Desuscrito</button>
                        </div>
                    </div>

                    <!-- Preview Content -->
                    <div class="preview-container p-6 rounded-lg h-96 relative overflow-hidden">
                        <!-- Bell Icon -->
                        <div id="bellIcon" class="absolute bottom-4 right-4">
                            <div
                                class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center shadow-lg cursor-pointer hover:bg-blue-600 transition-colors">
                                <span class="text-white text-xl">🔔</span>
                            </div>
                        </div>

                        <!-- Preview Modal -->
                        <div id="previewModal" class="bg-white rounded-lg p-4 max-w-sm mx-auto mt-8">
                            <!-- Close button -->
                            <button
                                class="absolute top-2 right-2 w-6 h-6 bg-black bg-opacity-50 rounded-full flex items-center justify-center text-white text-xs">×</button>

                            <!-- Notifications Section -->
                            <div id="notificationsSection" class="mb-4">
                                <h3 id="previewHeading" class="text-sm font-medium mb-3">Aquí hay algunas notificaciones
                                    que te perdiste:</h3>
                                <div id="notificationsList" class="space-y-2">
                                    <div class="border border-blue-200 rounded p-2 bg-blue-50">
                                        <div class="text-blue-600 text-sm font-medium">¡Bienvenido a PushSaaS!</div>
                                        <div class="text-xs text-gray-500">Hace 2 horas</div>
                                    </div>
                                    <div class="border border-blue-200 rounded p-2 bg-blue-50">
                                        <div class="text-blue-600 text-sm font-medium">Nueva función disponible</div>
                                        <div class="text-xs text-gray-500">Ayer</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Main Action -->
                            <div class="text-center">
                                <p id="previewTitle" class="text-sm text-gray-600 mb-4">Suscríbete para recibir
                                    notificaciones push sobre las últimas actualizaciones</p>
                                <button id="previewButton"
                                    class="w-full bg-blue-500 text-white py-2 px-4 rounded font-medium hover:bg-blue-600 transition-colors">
                                    SUSCRIBIRSE
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success Message -->
        <div id="success" class="hidden fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg">
            <div class="flex items-center">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd"
                        d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                        clip-rule="evenodd"></path>
                </svg>
                <span>Configuración actualizada exitosamente</span>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentTab = 'Default';
        let config = {
            style: 'Rounded',
            position: 'Bottom Left',
            theme: 'Dark',
            themeColor: '#4A90E2',
            popupStyle: 'Standard',
            xAxis: '15',
            yAxis: '15',
            defaultTitle: 'Suscríbete para recibir notificaciones push sobre las últimas actualizaciones',
            defaultButtonText: 'SUSCRIBIRSE',
            subscribedTitle: 'Estás suscrito a las notificaciones push',
            subscribedButtonText: 'DESUSCRIBIRSE',
            unsubscribedTitle: 'No estás suscrito a las notificaciones push',
            unsubscribedButtonText: 'SUSCRIBIRSE',
            showLastNotifications: true,
            defaultHeading: 'Aquí hay algunas notificaciones que te perdiste:',
            subscribedHeading: 'Notificaciones Recientes',
            isActive: true
        };

        // DOM elements
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const errorMessage = document.getElementById('error-message');
        const mainContent = document.getElementById('main-content');
        const success = document.getElementById('success');

        // Form elements
        const style = document.getElementById('style');
        const position = document.getElementById('position');
        const theme = document.getElementById('theme');
        const themeColor = document.getElementById('themeColor');
        const defaultTitle = document.getElementById('defaultTitle');
        const defaultButtonText = document.getElementById('defaultButtonText');
        const subscribedTitle = document.getElementById('subscribedTitle');
        const subscribedButtonText = document.getElementById('subscribedButtonText');
        const unsubscribedTitle = document.getElementById('unsubscribedTitle');
        const unsubscribedButtonText = document.getElementById('unsubscribedButtonText');
        const showLastNotifications = document.getElementById('showLastNotifications');
        const defaultHeading = document.getElementById('defaultHeading');
        const subscribedHeading = document.getElementById('subscribedHeading');

        // Preview elements
        const previewTabs = document.querySelectorAll('.preview-tab');
        const previewTitle = document.getElementById('previewTitle');
        const previewButton = document.getElementById('previewButton');
        const previewHeading = document.getElementById('previewHeading');
        const notificationsSection = document.getElementById('notificationsSection');

        // Toggle elements
        const toggleBg = document.getElementById('toggleBg');
        const toggleCircle = document.getElementById('toggleCircle');

        // Action buttons
        const updateBtn = document.getElementById('updateBtn');
        const hideBellBtn = document.getElementById('hideBellBtn');

        // Initialize
        async function init() {
            try {
                await loadConfig();
                setupEventListeners();
                updatePreview();
                hideLoading();
            } catch (err) {
                showError(err.message);
            }
        }

        // Load configuration from server
        async function loadConfig() {
            try {
                const response = await fetch('/api/subscription-bell/config');
                if (!response.ok) {
                    throw new Error('Error al cargar la configuración');
                }
                const data = await response.json();
                if (data.success && data.data) {
                    config = { ...config, ...data.data };
                }
                updateFormValues();
            } catch (err) {
                console.error('Error loading config:', err);
                // Use default config if server fails
                updateFormValues();
            }
        }

        // Update form values from config
        function updateFormValues() {
            style.value = config.style;
            position.value = config.position;
            theme.value = config.theme;
            themeColor.value = config.themeColor;
            defaultTitle.value = config.defaultTitle;
            defaultButtonText.value = config.defaultButtonText;
            subscribedTitle.value = config.subscribedTitle;
            subscribedButtonText.value = config.subscribedButtonText;
            unsubscribedTitle.value = config.unsubscribedTitle;
            unsubscribedButtonText.value = config.unsubscribedButtonText;
            showLastNotifications.checked = config.showLastNotifications;
            defaultHeading.value = config.defaultHeading;
            subscribedHeading.value = config.subscribedHeading;

            // Update toggle appearance
            updateToggle();
        }

        // Setup event listeners
        function setupEventListeners() {
            // Form changes
            [style, position, theme, themeColor, defaultTitle, defaultButtonText,
                subscribedTitle, subscribedButtonText, unsubscribedTitle, unsubscribedButtonText,
                defaultHeading, subscribedHeading].forEach(element => {
                    element.addEventListener('input', updatePreview);
                });

            // Toggle
            showLastNotifications.addEventListener('change', () => {
                updateToggle();
                updatePreview();
            });

            // Preview tabs
            previewTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    currentTab = tab.dataset.tab;
                    updateTabStyles();
                    updatePreview();
                });
            });

            // Action buttons
            updateBtn.addEventListener('click', saveConfig);
            hideBellBtn.addEventListener('click', toggleBellVisibility);
        }

        // Update toggle appearance
        function updateToggle() {
            if (showLastNotifications.checked) {
                toggleBg.className = 'w-10 h-6 bg-blue-500 rounded-full transition-colors';
                toggleCircle.className = 'w-4 h-4 bg-white rounded-full shadow transform transition-transform mt-1 translate-x-5';
            } else {
                toggleBg.className = 'w-10 h-6 bg-gray-300 rounded-full transition-colors';
                toggleCircle.className = 'w-4 h-4 bg-white rounded-full shadow transform transition-transform mt-1 translate-x-1';
            }
        }

        // Update tab styles
        function updateTabStyles() {
            previewTabs.forEach(tab => {
                if (tab.dataset.tab === currentTab) {
                    tab.className = 'preview-tab px-3 py-1 text-xs rounded transition-colors bg-blue-500 text-white';
                } else {
                    tab.className = 'preview-tab px-3 py-1 text-xs rounded transition-colors text-gray-600 hover:bg-white';
                }
            });
        }

        // Update preview
        function updatePreview() {
            // Update title and button based on current tab
            if (currentTab === 'Default') {
                previewTitle.textContent = defaultTitle.value;
                previewButton.textContent = defaultButtonText.value;
                previewHeading.textContent = defaultHeading.value;
            } else if (currentTab === 'When Subscribed') {
                previewTitle.textContent = subscribedTitle.value;
                previewButton.textContent = subscribedButtonText.value;
                previewHeading.textContent = subscribedHeading.value;
            } else {
                previewTitle.textContent = unsubscribedTitle.value;
                previewButton.textContent = unsubscribedButtonText.value;
                previewHeading.textContent = defaultHeading.value;
            }

            // Show/hide notifications
            notificationsSection.style.display = showLastNotifications.checked ? 'block' : 'none';

            // Update button color
            previewButton.style.backgroundColor = themeColor.value;
        }

        // Save configuration
        async function saveConfig() {
            try {
                updateBtn.disabled = true;
                updateBtn.textContent = 'Guardando...';

                const configData = {
                    style: style.value,
                    position: position.value,
                    theme: theme.value,
                    themeColor: themeColor.value,
                    defaultTitle: defaultTitle.value,
                    defaultButtonText: defaultButtonText.value,
                    subscribedTitle: subscribedTitle.value,
                    subscribedButtonText: subscribedButtonText.value,
                    unsubscribedTitle: unsubscribedTitle.value,
                    unsubscribedButtonText: unsubscribedButtonText.value,
                    showLastNotifications: showLastNotifications.checked,
                    defaultHeading: defaultHeading.value,
                    subscribedHeading: subscribedHeading.value,
                    isActive: config.isActive
                };

                const response = await fetch('/api/subscription-bell/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(configData)
                });

                if (!response.ok) {
                    throw new Error('Error al guardar la configuración');
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message || 'Error al guardar la configuración');
                }

                config = { ...config, ...configData };
                showSuccess();
            } catch (err) {
                showError(err.message);
            } finally {
                updateBtn.disabled = false;
                updateBtn.textContent = 'Actualizar Configuración';
            }
        }

        // Toggle bell visibility
        async function toggleBellVisibility() {
            try {
                hideBellBtn.disabled = true;
                const newStatus = !config.isActive;
                hideBellBtn.textContent = newStatus ? 'Ocultando...' : 'Mostrando...';

                const response = await fetch('/api/subscription-bell/toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ isActive: newStatus })
                });

                if (!response.ok) {
                    throw new Error('Error al cambiar la visibilidad');
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message || 'Error al cambiar la visibilidad');
                }

                config.isActive = newStatus;
                document.getElementById('status-badge').textContent = newStatus ? 'Active' : 'Inactive';
                document.getElementById('status-badge').className = `px-2 py-1 ${newStatus ? 'bg-green-500' : 'bg-gray-500'} text-white text-xs rounded font-medium`;
                hideBellBtn.textContent = newStatus ? 'Ocultar Campana' : 'Mostrar Campana';
                hideBellBtn.className = `px-4 py-2 ${newStatus ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'} text-white rounded transition-colors`;

                showSuccess();
            } catch (err) {
                showError(err.message);
            } finally {
                hideBellBtn.disabled = false;
            }
        }

        // Show/hide states
        function hideLoading() {
            loading.classList.add('hidden');
            mainContent.classList.remove('hidden');
        }

        function showError(message) {
            loading.classList.add('hidden');
            errorMessage.textContent = message;
            error.classList.remove('hidden');
        }

        function showSuccess() {
            success.classList.remove('hidden');
            setTimeout(() => {
                success.classList.add('hidden');
            }, 3000);
        }

        // Start the application
        init();
    </script>
</body>

</html>